<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Date Mini (svg.js)</title>
  <style>
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background:#ececec;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    #mount{
      width:min(92vw, 140px);
      aspect-ratio: 560 / 300;
    }
  </style>
</head>
<body>
<div id="mount"></div>

<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.2.4/dist/svg.min.js"></script>
<script>
const pad2 = (n) => String(n).padStart(2,"0");
const weekJP = ["日","月","火","水","木","金","土"];

function easeInOutCubic(t){
  return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2;
}

class FlipUnit{
  constructor(draw, x, y, w, h, opts={}){
    this.draw=draw; this.x=x; this.y=y; this.w=w; this.h=h;
    this.half=h/2;
    this.value="00";
    this.isFlipping=false;

    this.opticalNudge = opts.opticalNudge ?? 5;

    draw.rect(w,h).move(x+2,y+3)
      .fill("rgba(0,0,0,.25)").radius(10).opacity(.35);

    this.card=draw.group();
    this.card.rect(w,h).move(x,y).fill("#1f1f1f").radius(10);
    this.card.rect(w,this.half).move(x,y).fill("#262626").radius(10);

    const seamY = y + this.half + 0.5;
    this.card.line(x+10,seamY,x+w-10,seamY)
      .stroke({width:1,color:"rgba(255,255,255,.1)"});

    this.clipTop=draw.clip().add(draw.rect(w,this.half).move(x,y));
    this.clipBot=draw.clip().add(draw.rect(w,this.half).move(x,y+this.half));

    this.topStatic=draw.group().clipWith(this.clipTop);
    this.botStatic=draw.group().clipWith(this.clipBot);
    this.flap=draw.group().clipWith(this.clipTop);

    this.font={ family:"ui-monospace, Menlo, Consolas, monospace", size:64, weight:700 };

    // 計測用（不可視）
    this.measure = draw.text("00")
      .font(this.font)
      .fill("none")
      .opacity(0)
      .attr({ x:this.x+this.w/2, y:0, "text-anchor":"middle" });

    this.topText=this._txt(this.topStatic,this.value);
    this.botText=this._txt(this.botStatic,this.value);
    this.flapText=this._txt(this.flap,this.value);

    this._setText(this.topText,this.value);
    this._setText(this.botText,this.value);
    this._setText(this.flapText,this.value);
  }

  _txt(g,str){
    return g.text(str)
      .font(this.font)
      .fill("#f3f3f3")
      .attr({ x:this.x+this.w/2, y:this.y+this.h/2, "text-anchor":"middle" });
  }

  _calcCenteredY(str){
    const cx=this.x+this.w/2;
    const targetCy=this.y+this.h/2;

    this.measure.text(str).attr({x:cx,y:0});
    const b=this.measure.bbox();
    const bboxCenter=b.y+b.height/2;

    return targetCy - bboxCenter + this.opticalNudge;
  }

  _setText(el,str){
    el.text(str);
    el.attr({ y:this._calcCenteredY(str) });
  }

  setValue(v){
    this.value=v;
    this._setText(this.topText,v);
    this._setText(this.botText,v);
    this._setText(this.flapText,v);
  }

  flipTo(next,dur=650){
    if(this.isFlipping||next===this.value) return;
    this.isFlipping=true;

    const cur=this.value;
    this._setText(this.topText,cur);
    this._setText(this.botText,cur);
    this._setText(this.flapText,cur);

    const start=performance.now();
    const cx=this.x+this.w/2;
    const hingeY=this.y+this.half;
    let switched=false;

    const step=(now)=>{
      const t=Math.min(1,(now-start)/dur);
      const e=easeInOutCubic(t);

      this.flap.transform({
        translateX:cx,
        translateY:hingeY,
        scaleY:1-e,
        scaleX:1
      });

      if(!switched && t>0.52){
        switched=true;
        this._setText(this.topText,next);
        this._setText(this.botText,next);
        this._setText(this.flapText,next);
      }

      if(t<1) requestAnimationFrame(step);
      else{
        this.flap.untransform();
        this.value=next;
        this.isFlipping=false;
      }
    };
    requestAnimationFrame(step);
  }
}

/* ===== 描画 ===== */
const W=560,H=300;
const draw=SVG().addTo("#mount").viewbox(0,0,W,H).size("100%","100%");
draw.rect(W,H).fill("#f2f2f2");

const yearText=draw.text("2025")
  .font({family:"Georgia,'Times New Roman',serif",size:44,weight:700})
  .fill("#1a1a1a")
  .attr({x:W/2,y:52,"text-anchor":"middle","dominant-baseline":"middle"});

const cardW=150,cardH=120,gap=24;
const x0=(W-(cardW*2+gap))/2;
const y0=90;

const OPTICAL_NUDGE = 5;

const mm=new FlipUnit(draw,x0,y0,cardW,cardH,{opticalNudge:OPTICAL_NUDGE});
const dd=new FlipUnit(draw,x0+cardW+gap,y0,cardW,cardH,{opticalNudge:OPTICAL_NUDGE});

/* ===== 曜日 ===== */
const dowText=draw.text("金")
  .font({
    family:"'Hiragino Maru Gothic ProN','Rounded Mplus 1c','Yu Gothic UI','Meiryo',sans-serif",
    size:40,
    weight:600
  })
  .fill("rgba(0,0,0,.65)")
  .attr({
    x:x0+cardW*2+gap+28,
    y:y0+cardH/2,
    "text-anchor":"start",
    "dominant-baseline":"middle"
  });

function setDow(d){
  const w=weekJP[d.getDay()];
  dowText.text(w);
  if(w==="土") dowText.fill("#1f4fd8");
  else if(w==="日") dowText.fill("#d32f2f");
  else dowText.fill("rgba(0,0,0,.65)");
}

function setAll(d){
  yearText.text(d.getFullYear());
  mm.setValue(pad2(d.getMonth()+1));
  dd.setValue(pad2(d.getDate()));
  setDow(d);
}
setAll(new Date());

let lastKey=null;
const keyOf=d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

function tick(){
  const now=new Date();
  const k=keyOf(now);
  if(lastKey && k!==lastKey){
    const prev=new Date(now-1000);
    dd.flipTo(pad2(now.getDate()));
    if(prev.getMonth()!==now.getMonth()){
      setTimeout(()=>mm.flipTo(pad2(now.getMonth()+1)),220);
    }
    yearText.text(now.getFullYear());
    setDow(now);
  }
  lastKey=k;
  setTimeout(tick,1000-now.getMilliseconds());
}
tick();
</script>
</body>
</html>
